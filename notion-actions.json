import fetch from "node-fetch";
import { parsePageProperties } from "../parser.js";
import { logIssue } from "../logger.js";

const NOTION_VERSION = "2025-09-03";

export default async function handler(req, res) {
  try {
    console.log("---------------------------------------------------");
    console.log("ğŸ‘‰ Function invoked at:", new Date().toISOString());
    console.log("ğŸ‘‰ Raw req.body:", req.body);

    // Handle raw string body (Vercel sometimes passes strings)
    const body = typeof req.body === "string" ? JSON.parse(req.body) : req.body;
    console.log("ğŸ‘‰ Parsed body:", body);

    const { data_source_id, page_size = 1 } = body;
    console.log("ğŸ‘‰ Using data_source_id:", data_source_id);
    console.log("ğŸ‘‰ NOTION_TOKEN present?", !!process.env.NOTION_TOKEN);

    if (!data_source_id) {
      const message = "âŒ data_source_id is required in the request body.";
      console.error(message);
      return res.status(400).json({ error: message });
    }

    // Build query
    const notionURL = `https://api.notion.com/v1/data-sources/${data_source_id}/query`;
    console.log("ğŸ‘‰ Notion endpoint:", notionURL);

    const notionRes = await fetch(notionURL, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${process.env.NOTION_TOKEN}`,
        "Notion-Version": NOTION_VERSION,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ page_size })
    });

    console.log("ğŸ‘‰ Notion response status:", notionRes.status);

    // Read Notion response
    const text = await notionRes.text();
    console.log("ğŸ‘‰ Notion raw response text:", text);

    if (!notionRes.ok) {
      console.error("âŒ Notion API returned an error:", text);
      logIssue(`âŒ Notion API error: ${text}`);
      return res.status(notionRes.status).json({
        error: "Notion API error",
        details: text
      });
    }

    // Parse response
    const data = JSON.parse(text);
    console.log("âœ… Parsed Notion response successfully.");

    const parsed = data.results.map((page) =>
      parsePageProperties(page, logIssue)
    );

    res.status(200).json({
      message: "âœ… Successfully retrieved data from Notion.",
      parsed,
      raw: data
    });
  } catch (err) {
    console.error("âŒ queryDatabase crashed:", err.message);
    console.error(err.stack);
    logIssue(`âŒ queryDatabase crashed: ${err.message}`);
    res.status(500).json({ error: err.message });
  }
}